<template>
  <div class="container-fluid h-100">
    <h1>
      Pewny Poker -
      <span class="connection_ready" v-if="connection_ready">
        Connection ready!
      </span>
    </h1>
    <InviteUser />

    <div class="container-fluid users" id="users">
      <div class="users-container">
        <h1 class="error" v-if="connection_error">Connection error!</h1>
        <div v-for="(m, idx) in userList" :key="'m-' + idx">
          <div>
            {{ m.name }}
          </div>
        </div>
      </div>
      <div class="container-fluid logo-container">
        <svg
          width="146"
          height="33"
          viewBox="0 0 146 33"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <g clip-path="url(#clip0_803_2)">
            <path
              d="M29.1427 3.42904C29.1504 3.8842 29.0675 4.33636 28.8987 4.75913C28.7299 5.18191 28.4786 5.56684 28.1594 5.89147C27.8403 6.2161 27.4597 6.47394 27.0399 6.64995C26.6201 6.82595 26.1694 6.91659 25.7142 6.91659C25.2589 6.91659 24.8083 6.82595 24.3884 6.64995C23.9686 6.47394 23.588 6.2161 23.2689 5.89147C22.9497 5.56684 22.6984 5.18191 22.5296 4.75913C22.3608 4.33636 22.2779 3.8842 22.2857 3.42904C22.301 2.52988 22.669 1.67275 23.3103 1.04231C23.9516 0.411871 24.8149 0.0585937 25.7142 0.0585938C26.6134 0.0585938 27.4767 0.411871 28.118 1.04231C28.7593 1.67275 29.1273 2.52988 29.1427 3.42904Z"
              fill="#00A597"
            ></path>
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M5.968 26.0498C5.4 25.8028 4.911 25.5158 3.984 24.9488L0 29.0098C0.337 29.2598 0.69 29.4998 1.06 29.7288C2.097 30.3708 3.26 30.9198 4.55 31.2898C4.8758 31.378 5.20392 31.4573 5.534 31.5278C6.993 31.8408 8.55 31.9978 10.204 32.0008H10.246C12.046 32.0008 13.647 31.7078 15.049 31.1238C15.1149 31.0961 15.1806 31.0678 15.246 31.0388C15.9167 30.7395 16.5528 30.368 17.143 29.9308C17.743 29.4808 18.262 28.9718 18.698 28.4058L18.729 28.3658C19.576 27.2508 19.999 25.9688 19.999 24.5208C19.999 23.1808 19.646 22.0248 18.939 21.0538C18.73 20.768 18.4954 20.5019 18.238 20.2588C17.9058 19.9295 17.5386 19.6374 17.143 19.3878C16.381 18.9038 15.479 18.5398 14.437 18.2948C14.0679 18.2084 13.6952 18.1384 13.32 18.0848L9.016 17.4168C8.92118 17.4025 8.82651 17.3871 8.732 17.3708C7.952 17.2358 7.392 17.0568 7.049 16.8318C6.667 16.5538 6.475 16.1918 6.475 15.7458L6.477 15.6778C6.494 15.3598 6.633 15.0878 6.894 14.8608C7.00508 14.767 7.12575 14.6852 7.254 14.6168C7.664 14.3758 8.175 14.2288 8.789 14.1778C8.95994 14.1633 9.13145 14.1566 9.303 14.1578C9.52184 14.1574 9.74063 14.1644 9.959 14.1788C10.822 14.2348 11.675 14.396 12.499 14.6588C12.744 14.7288 12.979 14.8138 13.213 14.9108C13.4026 14.9902 13.5894 15.0763 13.773 15.1688C14.265 15.4148 14.763 15.7118 15.313 16.0388L15.653 16.2428L19.638 12.1798C19.293 11.9498 18.9 11.7118 18.479 11.4758C18.0413 11.2307 17.5957 11 17.143 10.7838C16.293 10.3778 15.423 10.0268 14.672 9.8118C14.4324 9.74343 14.1913 9.68008 13.949 9.6218C12.4293 9.25258 10.8658 9.09542 9.303 9.1548C7.641 9.2148 6.193 9.5028 4.959 10.0208C4.84642 10.066 4.73473 10.1133 4.624 10.1628C3.392 10.7138 2.424 11.4888 1.721 12.4858C1.433 12.8998 1.201 13.3478 1.026 13.8288C0.752 14.5798 0.615 15.4138 0.615 16.3308C0.615 17.5248 0.858 18.5738 1.345 19.4768C1.597 19.9438 1.914 20.3708 2.295 20.7598C3.101 21.5428 4.157 22.1328 5.463 22.5308C6.015 22.6998 6.613 22.8328 7.254 22.9328L11.557 23.6008C12.322 23.7128 12.882 23.9078 13.237 24.1858C13.593 24.4368 13.77 24.7708 13.77 25.1888C13.77 25.2338 13.768 25.2788 13.763 25.3208C13.723 25.6888 13.515 26.0068 13.138 26.2748C13.0264 26.3529 12.9095 26.4231 12.788 26.4848C12.394 26.6758 11.911 26.8078 11.336 26.8798C11.2495 26.8907 11.1628 26.9001 11.076 26.9078L11.043 26.9108C10.7779 26.9324 10.512 26.9434 10.246 26.9438H10.205C9.591 26.9438 8.972 26.8868 8.349 26.7728C7.85346 26.6806 7.36443 26.5564 6.885 26.4008L6.725 26.3448C6.46979 26.2549 6.21665 26.1565 5.968 26.0498ZM22.857 9.1458V32.0028H28.571V9.1448L22.857 9.1458ZM38.857 18.7128V32.0028H33.143V9.1448H38.857V11.8448C39.8638 11.3191 40.9157 10.8847 42 10.5468C43.8497 9.96938 45.7763 9.67571 47.714 9.6758V15.3898C44.5187 15.3899 41.4276 16.5263 38.993 18.5958L38.857 18.7108V18.7128ZM48.869 21.1058C49.147 27.1708 54.152 32.0018 60.285 32.0018C64.133 32.0018 67.537 30.1008 69.608 27.1858C70.9815 25.2549 71.7177 22.9433 71.714 20.5738C71.714 18.1098 70.934 15.8278 69.608 13.9618C68.5525 12.4719 67.155 11.2569 65.5328 10.4189C63.9105 9.58091 62.1109 9.14432 60.285 9.1458C57.712 9.1458 55.338 9.9958 53.428 11.4298C52.0302 12.4796 50.8905 13.8347 50.096 15.3918C49.1966 17.1572 48.7736 19.1268 48.869 21.1058ZM87.313 9.3108C85.1927 8.94379 83.0117 9.18798 81.025 10.0148L81.009 10.0208C78.9339 10.8883 77.1621 12.3508 75.917 14.2238L75.905 14.2418C74.6613 16.119 73.9981 18.321 73.9981 20.5728C73.9981 22.8246 74.6613 25.0266 75.905 26.9038L75.917 26.9218C77.1621 28.7948 78.9339 30.2573 81.009 31.1248L81.025 31.1308C83.1036 31.9953 85.3924 32.2216 87.6 31.7808H87.61C89.8163 31.3384 91.8413 30.2503 93.428 28.6548L89.412 24.6218L89.403 24.6128L89.395 24.6218L89.387 24.6298L89.37 24.6468C88.5796 25.4265 87.5786 25.9583 86.49 26.1768L86.481 26.1788C85.3856 26.3962 84.2503 26.2849 83.218 25.8588L83.203 25.8518C82.162 25.4185 81.2731 24.6859 80.649 23.7468C80.0215 22.8033 79.6878 21.6949 79.6901 20.5618C79.6924 19.4287 80.0306 18.3217 80.662 17.3808C81.2851 16.4506 82.1686 15.7247 83.202 15.2938L83.218 15.2878C84.2505 14.8623 85.3855 14.751 86.481 14.9678L86.491 14.9688C87.5796 15.1865 88.5805 15.7184 89.37 16.4988L89.387 16.5158C89.3896 16.5185 89.3923 16.5212 89.395 16.5238L89.403 16.5328L89.413 16.5238L93.428 12.4918C91.8401 10.8979 89.8156 9.81009 87.61 9.3658L87.6 9.3638C87.5046 9.3446 87.4089 9.32693 87.313 9.3108ZM103.447 31.8348C104.823 32.0731 106.231 32.0551 107.6 31.7818L107.609 31.7798C109.784 31.344 111.783 30.2805 113.36 28.7208L113.428 28.6538L109.412 24.6218L109.403 24.6128L109.394 24.6218C109.392 24.6247 109.389 24.6274 109.386 24.6298L109.37 24.6468C108.58 25.4274 107.579 25.9594 106.49 26.1768L106.481 26.1788L106.341 26.2048C105.288 26.3859 104.205 26.2656 103.218 25.8578L103.203 25.8518C102.169 25.4211 101.285 24.6952 100.661 23.7648L100.649 23.7468C100.024 22.8064 99.69 21.7022 99.69 20.5728C99.69 19.4434 100.024 18.3392 100.649 17.3988L100.661 17.3808C101.285 16.4504 102.169 15.7245 103.203 15.2938L103.218 15.2878C104.25 14.8619 105.386 14.7506 106.481 14.9678L106.49 14.9688C107.579 15.1862 108.58 15.7182 109.37 16.4988L109.386 16.5158L109.394 16.5238L109.403 16.5328L109.412 16.5238L113.428 12.4918L113.36 12.4248C111.783 10.8652 109.784 9.80149 107.609 9.3648H107.6C105.392 8.92386 103.104 9.15014 101.025 10.0148L101.009 10.0208C98.9342 10.8888 97.1626 12.3512 95.917 14.2238L95.905 14.2418C94.6612 16.119 93.9979 18.3209 93.9979 20.5728C93.9979 22.8247 94.6612 25.0266 95.905 26.9038L95.917 26.9218C97.1626 28.7944 98.9342 30.2568 101.009 31.1248L101.025 31.1308C101.808 31.4568 102.62 31.6918 103.447 31.8348ZM114.013 21.1438C114.108 23.0828 114.687 24.8938 115.63 26.4608C116.627 28.1143 118.024 29.49 119.693 30.4608C121.378 31.4408 123.337 32.0008 125.427 32.0008C131.739 32.0008 136.856 26.8848 136.856 20.5728C136.856 14.2608 131.739 9.1448 125.427 9.1448C123.337 9.1448 121.378 9.7048 119.693 10.6848C118.024 11.6556 116.627 13.0313 115.63 14.6848C114.458 16.6281 113.895 18.8777 114.013 21.1438ZM60.285 26.2868C61.8004 26.2868 63.2538 25.6848 64.3254 24.6132C65.397 23.5416 65.999 22.0882 65.999 20.5728C65.999 19.0574 65.397 17.604 64.3254 16.5324C63.2538 15.4608 61.8004 14.8588 60.285 14.8588C58.7696 14.8588 57.3162 15.4608 56.2446 16.5324C55.173 17.604 54.571 19.0574 54.571 20.5728C54.571 22.0882 55.173 23.5416 56.2446 24.6132C57.3162 25.6848 58.7696 26.2868 60.285 26.2868ZM125.427 26.2868C126.943 26.2868 128.396 25.6847 129.468 24.6129C130.54 23.5411 131.142 22.0875 131.142 20.5718C131.142 19.0561 130.54 17.6025 129.468 16.5307C128.396 15.4589 126.943 14.8568 125.427 14.8568C123.911 14.8568 122.458 15.4589 121.386 16.5307C120.314 17.6025 119.712 19.0561 119.712 20.5718C119.712 22.0875 120.314 23.5411 121.386 24.6129C122.458 25.6847 123.911 26.2868 125.427 26.2868Z"
              fill="#001F5F"
            ></path>
            <path
              d="M145.998 28.5707C146.006 29.0258 145.923 29.478 145.754 29.9007C145.585 30.3235 145.334 30.7084 145.015 31.033C144.695 31.3575 144.315 31.6153 143.895 31.7913C143.475 31.9672 143.024 32.0578 142.569 32.0577C142.114 32.0576 141.663 31.9669 141.243 31.7909C140.824 31.6148 140.443 31.3569 140.124 31.0322C139.805 30.7076 139.554 30.3226 139.385 29.8998C139.216 29.477 139.133 29.0248 139.141 28.5697C139.156 27.6705 139.524 26.8134 140.166 26.1829C140.807 25.5525 141.67 25.1992 142.57 25.1992C143.469 25.1992 144.332 25.5525 144.974 26.1829C145.615 26.8134 145.983 27.6715 145.998 28.5707Z"
              fill="#FFD200"
            ></path>
          </g>
          <defs>
            <clipPath id="clip0_803_2">
              <rect width="146" height="33" fill="white"></rect>
            </clipPath>
          </defs>
        </svg>
      </div>
    </div>
    <UserVotes />
  </div>
</template>

<script>
import UserVotes from "@/components/UserVotes.vue";
import InviteUser from "@/components/InviteUser.vue";
import { mapGetters } from "vuex";

export default {
  name: "TableView",
  data() {
    return {
      sockets_bay_api_key: "050339dc6abdd58a81c9098cb8483814", //here you must insert your api key from Sockets Bay
      connection_ready: false,
      connection_error: false,
      nickname: "",
      websocket: null,
      users: [],
    };
  },
  computed: {
    userList: {
      get() {
        return this.$store.state.users;
      },
      set(value) {
        this.$store.dispatch("addUser", value);
      },
    },
    userVote() {
      return this.$store.state.user.vote;
    },
    ...mapGetters(["myId", "getUserByName", "getUser"]),
  },
  watch: {
    userVote(newValue, oldValue) {
      if ((newValue != oldValue) & !this.$store.state.user.voted) {
        this.prepareAndSendMessage("VT");
        this.$store.dispatch("setVoted");
      }
    },
  },
  methods: {
    init_chat() {
      //ask for a nickname
      this.nickname = this.$store.state.user.name;
      this.userList = { name: this.nickname, vote: null };
      //connect to Sockets Bay
      var sockets_bay_url = `wss://socketsbay.com/wss/v2/100/${this.sockets_bay_api_key}/`;
      this.websocket = new WebSocket(sockets_bay_url);
      //
      this.websocket.onopen = this.onSocketOpen;
      this.websocket.onmessage = this.onSocketMessage;
      this.websocket.onerror = this.onSockerError;
    },
    onSocketOpen() {
      this.connection_ready = true;
      this.prepareAndSendMessage("ACK");
    },
    onSockeClose() {
      this.prepareAndSendMessage("BYE");
    },
    onSocketMessage(evt) {
      //we parse the json that we receive
      console.log(evt);
      var received = JSON.parse(evt.data);
      //check if it's our message or from a friend
      this.handleMessage(received);
      //scroll to the bottom of the messages div
      const messages_div = document.getElementById("users");
      messages_div.scrollTo({
        top: messages_div.scrollHeight,
        behavior: "smooth",
      });
    },
    onSockerError() {
      this.connection_error = true;
    },
    send_hello() {
      var to_send = { from: this.nickname, message: "" };
      this.websocket.send(JSON.stringify(to_send));
    },
    sendMessage(messageObj) {
      this.websocket.send(JSON.stringify(messageObj));
    },
    prepareAndSendMessage(type) {
      var message = {};
      switch (type) {
        case "ACKR":
          message = {
            type: type,
            data: this.userList,
          };
          break;
        case "BYE":
          message = {
            type: type,
            data: this.getUser,
          };
          break;
        case "ACK":
          message = {
            type: type,
            data: this.getUser,
          };
          break;
        case "VT":
          message = {
            type: type,
            data: this.getUser,
          };
          break;
        default:
          console.log("DPA");
      }
      this.sendMessage(message);
    },
    handleMessage(message) {
      let type = message.type;
      switch (type) {
        case "ACK":
          console.log(this.myId);
          if (this.myId === 0) {
            this.userList = message.data;
            this.prepareAndSendMessage("ACKR");
          }
          break;
        case "BYE":
          this.$store.dispatch("removeUser", message.data);
          break;
        case "VT":
          this.$store.dispatch("setUserVoted", message.data);
          break;
        case "ACKR":
          if (this.userList.length === 0) {
            console.log(message.data);
            this.$store.dispatch("setUsetList", message.data.data);
          }
      }
    },
  },
  mounted() {
    this.init_chat();
  },
  components: { UserVotes, InviteUser },
};
</script>

<style lang="sass"></style>
